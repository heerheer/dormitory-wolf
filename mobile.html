<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>927ç‹¼äººæ€ä¸“ç”¨å·¥å…·</title>
    <meta name="viewport" content="width=device-width, initial-scale=1 user-scalable=0 user-scalable=no">
    <!-- å¯¼å…¥æ ·å¼ -->
    <link href="mobile.css" rel="stylesheet">
    <!-- å¼•å…¥æ ·å¼æ–‡ä»¶ -->
    <link rel="stylesheet" href="//unpkg.com/vant@3/lib/index.css"/>
    <!-- å¼•å…¥ Vue å’Œ Vant çš„ JS æ–‡ä»¶ -->
    <script src="//unpkg.com/vue@3"></script>

    <script src="//unpkg.com/vant@3/lib/vant.min.js"></script>
</head>
<body>
<div id="app">
    <h1>ğŸ–åŠ å…¥å¯¹å±€</h1>
    <van-cell-group inset>
        <van-field v-model="room" label="æˆ¿é—´å·" placeholder="è¯·è¾“å…¥æˆ¿é—´å·" required></van-field>
        <van-button type="primary" round block plain icon="aim" @click="loadRooms()">å¿«é€Ÿé€‰æˆ¿</van-button>
        <van-field v-model="user" label="åå­—" placeholder="(é€‰å¡«)è¯·è¾“å…¥ä½ çš„åå­—"></van-field>
    </van-cell-group>
    <div style="height: 1rem"></div>
    <van-button v-if="!joined" type="primary" block round icon="smile-comment-o" @click="joinGame">æŠ½å–è§’è‰²å¡</van-button>
    <van-button v-if="joined" type="success" block round icon="smile-comment-o" @click="joined=false;room=''">é‡ç½®é¡µé¢
    </van-button>
    <div v-if="joined">
        <div style="height: 1rem"></div>
        <p>æˆ¿é—´å·²åŠ å…¥ {{ nowJoinCount }} ç©å®¶</p>
    </div>
    <div style="height: 1rem"></div>
    <van-button type="warning" block round icon="vip-card-o" @click="god">ä¸Šå¸æ¨¡å¼</van-button>

    <van-popup v-model:show="showPicker" round position="bottom">
        <van-picker
                title="å¿«é€Ÿæˆ¿é—´"
                :columns="rooms"
                @cancel="showPicker=false"
                @confirm="onRoomSlected"
        ></van-picker>
    </van-popup>

    <van-dialog v-model:show="godShow" title="ä¸Šå¸è§†è§’" show-cancel-button>

    </van-dialog>
</div>
<script>
    const {createApp} = Vue
    const {Dialog} = vant;

    const getRoleEmoji = (role) => {
        switch (role) {
            case 'ç‹¼äºº':
                return 'ğŸº'
            case 'å¹³æ°‘':
                return 'ğŸ˜…'
            case 'é¢„è¨€å®¶':
                return 'ğŸ•µï¸â€â™‚ï¸'
            case 'å¥³å·«':
                return 'ğŸ‘©â€ğŸ”¬'
        }
    }
    let app = createApp({
        data() {
            return {
                message: 'Hello Vue!',
                room: '',
                user: '',
                showPicker: false,
                rooms: [],
                godShow: false,
                nowJoinCount: 0,
                joined: false
            }
        },
        mounted() {
            setInterval(async () => {
                if (this.$data.joined) {
                    let room = this.$data.room
                    if (room && room !== '') {
                        let data = await (await fetch("/wolf/" + room, {method: 'get'})).json();
                        this.$data.nowJoinCount = data.room.players.length
                    }
                }
            }, 1000)
        },
        methods: {
            onRoomSlected: function (value, index) {
                this.$data.room = value
                this.$data.showPicker = false;
            },
            async loadRooms() {
                let data = await (await fetch("/wolf")).json();
                this.$data.rooms = Object.keys(data.rooms)
                this.$data.showPicker = true;
            },
            //åŠ å…¥æ¸¸æˆæ–¹æ³•
            async joinGame() {
                //æ£€æŸ¥roomå¡«äº†æ²¡
                let room = this.$data.room
                let user = this.$data.user
                if (!room || room === '') {
                    Dialog.alert({
                        title: 'åŠ å…¥å¤±è´¥',
                        message: 'è¯·å¡«å†™æˆ¿é—´ï¼Œæˆ–è€…å¿«é€Ÿé€‰æˆ¿ã€‚',
                    })
                }
                //ä»æœ¬åœ°å‚¨å­˜è·å–
                if (localStorage.getItem(room)) {
                    let s_role = localStorage.getItem(room);
                    if (s_role !== '') {
                        Dialog.alert({
                            title: 'é‡å¤åŠ å…¥',
                            message: 'ä½ ä¸å¯ä»¥é‡å¤åŠ å…¥ï¼Œä½†æˆ‘ä¾ç„¶å¯ä»¥å‘Šè¯‰ä½ ï¼Œä½ æ˜¯ã€Œ' + getRoleEmoji(s_role) + s_role + 'ã€',
                        })
                        this.$data.joined = true
                        return;
                    }
                }
                //ç”¨fetchå‘èµ·è¯·æ±‚
                let data = await (await fetch("/wolf/" + room, {method: 'post', body: JSON.stringify({user})})).json();
                //è·å–è¿”å›æ•°æ®
                let role = data.role;
                let left = data.left;
                //æç¤ºæˆåŠŸ
                Dialog.alert({
                    title: 'åŠ å…¥æˆåŠŸ',
                    message: 'ä½ æ˜¯ã€Œ' + getRoleEmoji(role) + role + 'ã€',
                })
                //æœ¬åœ°ä¿å­˜è‡ªå·±çš„èŒä¸š
                localStorage.setItem(room, role)
                this.$data.joined = true
            },
            async god() {
                //æ£€æŸ¥room
                let room = this.$data.room
                if (!room || room === '') {
                    Dialog.alert({
                        title: 'ä¸Šå¸å¤±è´¥',
                        message: 'è¯·å¡«å†™æˆ¿é—´ï¼Œæˆ–è€…å¿«é€Ÿé€‰æˆ¿ã€‚',
                    })
                }
                let data = await (await fetch("/wolf/" + room, {method: 'get'})).json();
                let room_data = data.room;

                let msg = [`æˆ¿é—´å·${room}`, 'ğŸ‘¼ä»¥ä¸‹æ˜¯äººå‘˜ä¿¡æ¯:']

                room_data.players.forEach(x => {
                    msg.push(`${x.user} æ˜¯ ${getRoleEmoji(x.role)}  ${x.role}`)
                })

                Dialog.alert({
                    title: 'æŸ¥çœ‹ä¿¡æ¯',
                    message: msg.join('\n'),
                })


                //this.$data.godShow = true
            }
        }
    });

    app.use(vant).mount('#app')
    app.use(vant.Button);
    app.use(vant.Field);
    app.use(vant.CellGroup);
    app.use(vant.Picker);
    app.use(Dialog);
</script>
</body>
</html>