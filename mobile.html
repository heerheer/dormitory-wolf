<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>å§å”§å§å”§çº¿ä¸‹å¨±ä¹å·¥å…·</title>
    <meta name="viewport" content="width=device-width, initial-scale=1 user-scalable=0 user-scalable=no">
    <!-- å¯¼å…¥æ ·å¼ -->
    <link href="mobile.css" rel="stylesheet">
    <!-- å¼•å…¥æ ·å¼æ–‡ä»¶ -->
    <link rel="stylesheet" href="//unpkg.com/vant@3/lib/index.css"/>
    <!-- å¼•å…¥ Vue å’Œ Vant çš„ JS æ–‡ä»¶ -->
    <script src="//unpkg.com/vue@3"></script>

    <script src="//unpkg.com/vant@3/lib/vant.min.js"></script>
</head>
<body>
<div id="app">
    <div v-if="tab ==='wolf'">
        <h1>ğŸ–åŠ å…¥ç‹¼äººæ€</h1>
        <van-cell-group inset>
            <van-field v-model="room" label="æˆ¿é—´å·" placeholder="è¯·è¾“å…¥æˆ¿é—´å·" required></van-field>
            <div style="height: 1rem"></div>

            <van-button v-if="!joined" type="primary" round block plain icon="aim" @click="loadRooms('wolf')">å¿«é€Ÿé€‰æˆ¿
            </van-button>
            <div style="height: 1rem"></div>

            <van-field v-model="user" required label="åå­—" placeholder="è¯·è¾“å…¥ä½ çš„åå­—"></van-field>
        </van-cell-group>
        <div style="height: 1rem"></div>
        <van-button v-if="!joined" type="primary" block round icon="smile-comment-o" @click="joinGame('wolf')">æŠ½å–è§’è‰²å¡
        </van-button>
        <van-button v-if="joined" type="success" block round icon="smile-comment-o" @click="joined=false;room=''">é‡ç½®é¡µé¢
        </van-button>
        <div v-if="joined">
            <div style="height: 1rem"></div>
            <p>æˆ¿é—´å·²åŠ å…¥ {{ nowJoinCount }} ç©å®¶</p>
        </div>
        <div style="height: 1rem"></div>
        <van-button type="warning" block round icon="vip-card-o" @click="god('wolf')">ä¸Šå¸æ¨¡å¼</van-button>
        <div style="height: 1rem"></div>
        <van-button type="danger" block round icon="delete-o" @click="deleteRoom" v-if="(room&&room!=='')">åˆ é™¤æˆ¿é—´
        </van-button>
    </div>

    <div v-if="tab ==='undercover'">
        <h1>ğŸ•µï¸â€è°æ˜¯å§åº•</h1>
        <van-cell-group inset>
            <van-field v-model="room" label="æˆ¿é—´å·" placeholder="è¯·è¾“å…¥æˆ¿é—´å·" required></van-field>
            <div style="height: 1rem"></div>

            <van-button v-if="!joined" type="primary" round block plain icon="aim" @click="loadRooms('undercover')">å¿«é€Ÿé€‰æˆ¿
            </van-button>
            <div style="height: 1rem"></div>

            <van-field v-model="user" required label="åå­—" placeholder="è¯·è¾“å…¥ä½ çš„åå­—"></van-field>
        </van-cell-group>
        <div style="height: 1rem"></div>
        <van-button v-if="!joined" type="primary" block round icon="smile-comment-o" @click="joinGame('undercover')">
            æŠ½å–ä½ çš„è¯è¯­
        </van-button>
        <van-button v-if="joined" type="success" block round icon="smile-comment-o" @click="joined=false;room=''">é‡ç½®é¡µé¢
        </van-button>
        <div v-if="joined">
            <div style="height: 1rem"></div>
            <p>æˆ¿é—´å·²åŠ å…¥ {{ nowJoinCount }} ç©å®¶</p>
        </div>
        <div style="height: 1rem"></div>
        <van-button v-if="joined" type="warning" block round icon="flag-o" @click="showVote()">æŠ•ç¥¨æ¨¡å¼</van-button>
        <div style="height: 1rem" v-if="joined"></div>
        <van-button type="warning" block round icon="vip-card-o" @click="god('undercover')">ä¸Šå¸æ¨¡å¼</van-button>
        <div style="height: 1rem"></div>
        <van-button type="danger" block round icon="delete-o" @click="deleteRoom" v-if="(room&&room!=='')">åˆ é™¤æˆ¿é—´
        </van-button>
    </div>

    <div v-if="tab =='me'">
        <h1>ğŸ¥‚æˆ‘çš„ä¿¡æ¯</h1>

        <van-cell-group inset>
            <van-cell title="å”¯ä¸€UID" :value="getLocalUid()"></van-cell>
            <van-cell title="æœ¬åœ°å" :value="getLocalUserInfo().name"></van-cell>

        </van-cell-group>
    </div>

    <van-overlay :show="role_img.show" @click="role_img.show = false">

        <div class="wrapper">
            <div class="role-card">

                <img style="height: 80%;width: 80%; object-fit:scale-down" :src="role_img.src"/>
            </div>

        </div>
    </van-overlay>


    <van-tabbar v-model="tab" fixed="true" @change="onTabChange">
        <van-tabbar-item icon="fire-o" name="wolf">ç‹¼äººæ€</van-tabbar-item>
        <!--        <van-tabbar-item icon="search">å†å²</van-tabbar-item>-->
        <van-tabbar-item icon="aim" name="undercover">è°æ˜¯å§åº•</van-tabbar-item>
        <van-tabbar-item icon="smile-o" name="me">æˆ‘</van-tabbar-item>
    </van-tabbar>

    <van-popup v-model:show="showPicker" round position="bottom">
        <van-picker
                title="å¿«é€Ÿæˆ¿é—´"
                :columns="rooms"
                @cancel="showPicker=false"
                @confirm="onRoomSelected"
        ></van-picker>
    </van-popup>

    <van-dialog v-model:show="voteShow" title="æŠ•ç¥¨æ¨¡å¼" show-cancel-button>
        <div v-if="voteShow">
            <van-cell-group inset>
                <van-cell v-for="player in voteData" :title="player.user">
                    <template #right-icon>
                        <van-button @click="votePlayer(player.user)">æŠ•ä»–</van-button>
                    </template>
                </van-cell>
            </van-cell-group>
        </div>
    </van-dialog>


</div>
<script>

    const {createApp} = Vue
    const {Dialog, Toast} = vant;

    const getRoleEmoji = (role) => {
        switch (role) {
            case 'ç‹¼äºº':
                return 'ğŸº'
            case 'å¹³æ°‘':
                return 'ğŸ˜…'
            case 'é¢„è¨€å®¶':
                return 'ğŸ•µï¸â€â™‚ï¸'
            case 'å¥³å·«':
                return 'ğŸ‘©â€ğŸ”¬'
            default:
                return ''
        }
    }

    const nanoid = (t = 21) => crypto.getRandomValues(new Uint8Array(t)).reduce(((t, e) => t += (e &= 63) < 36 ? e.toString(36) : e < 62 ? (e - 26).toString(36).toUpperCase() : e < 63 ? "_" : "-"), "");

    const api = {
        async getRooms() {
            return (await (await fetch("/rooms")).json()).rooms;
        },
        async getRoom(room, mode) {
            return (await (await fetch(`/${mode}/` + room, {method: 'get'})).json()).room;
        },
        async delRoom(room) {
            return await fetch("/rooms/" + room, {method: 'delete'});
        },
        async joinRoom(room, user, uid, mode) {
            return (await (await fetch("/wolf/" + room, {
                method: 'post',
                body: JSON.stringify({user, uid, mode})
            })).json()).role
        },
        getPicLink(role) {
            return "/pics/" + role + ".png";
        }

    }
    const getLocalUid = () => {
        if (!localStorage.getItem('uid')) {
            localStorage.setItem('uid', nanoid())
        }
        return localStorage.getItem('uid')
    }

    //å°†roomæ•°æ®è½¬åŒ–ä¸ºplayer-word-undercoveræ•°æ®
    const turnUndercoverDara = () => {

    }
    let app = createApp({
        data() {
            return {
                message: 'Hello Vue!',
                room: '',
                user: '',
                showPicker: false,
                rooms: [],
                godShow: false,
                nowJoinCount: 0,
                joined: false,
                tab: 'wolf',
                role_img: {src: '', show: false},
                voteShow: false,
                voteData: undefined
            }
        },
        mounted() {
            setInterval(async () => {
                if (this.$data.joined) {
                    let room = this.$data.room
                    if (room && room !== '') {
                        let data = await api.getRoom(room, this.$data.tab)
                        this.$data.nowJoinCount = data.players.length
                    }
                }
            }, 3000)

            //è‡ªåŠ¨å¡«å†™user name
            {
                if (localStorage.getItem('user.name')) {
                    this.user = localStorage.getItem('user.name')
                    Toast('æ¬¢è¿,' + this.user)
                }
            }
        },
        methods: {
            onTabChange(active) {
                this.$data.tab = active
            },
            getLocalUid() {
                return getLocalUid();
            },
            getLocalUserInfo() {
                const d = (key) => localStorage.getItem("user." + key);
                return {name: d('name')}
            },
            onRoomSelected: function (value, index) {
                this.$data.room = value
                this.$data.showPicker = false;
            },
            async loadRooms(mode) {
                this.$data.rooms = (await api.getRooms()).filter(x => x.mode === mode).map(x => x.id)
                this.$data.showPicker = true;
            },
            //åŠ å…¥æ¸¸æˆæ–¹æ³•
            async joinGame(mode) {
                if (!mode) {
                    mode = this.tab;
                }
                //æ£€æŸ¥roomå¡«äº†æ²¡
                let room = this.$data.room
                let user = this.$data.user
                let uid = getLocalUid();
                if (!room || room === '') {
                    Dialog.alert({
                        title: 'åŠ å…¥å¤±è´¥',
                        message: 'è¯·å¡«å†™æˆ¿é—´ï¼Œæˆ–è€…å¿«é€Ÿé€‰æˆ¿ã€‚',
                    })
                    return;
                }
                if (!user || user === '') {
                    Dialog.alert({
                        title: 'åŠ å…¥å¤±è´¥',
                        message: 'è¯·å¡«å†™åå­—!å¯ä»¥éšä¾¿å†™å“¦~',
                    })
                    return;
                }
                localStorage.setItem('user.name', this.user)

                let room_data = await api.getRoom(room, mode);
                if (room_data.players.findIndex(x => x.uid === uid) >= 0) {
                    let role = room_data.players.find(x => x.uid === uid).role
                    Dialog.alert({
                        title: 'é‡å¤åŠ å…¥',
                        message: 'ä½ åˆšåˆšå·²ç»åŠ å…¥è¿‡äº†!\nä½ æ˜¯ã€Œ' + getRoleEmoji(role) + role + 'ã€',
                    })
                    this.$data.joined = true;
                    return;
                }

                if (mode === 'wolf') {
                    //ç”¨fetchå‘èµ·è¯·æ±‚
                    let role = await api.joinRoom(room, user, uid, 'wolf');
                    this.role_img.src = api.getPicLink(role);
                    this.role_img.show = true;
                } else if (mode === 'undercover') {
                    let role = await api.joinRoom(room, user, uid, 'undercover');
                    Dialog.alert({
                        title: 'åŠ å…¥æˆåŠŸ',
                        message: 'ä½ çš„è¯è¯­æ˜¯ã€Œ' + role + 'ã€',
                    })
                }
                this.$data.joined = true


            },
            async god(mode) {
                if (!mode) {
                    mode = this.tab;
                }
                //æ£€æŸ¥room
                let room = this.$data.room
                if (!room || room === '') {
                    Dialog.alert({
                        title: 'ä¸Šå¸å¤±è´¥',
                        message: 'è¯·å¡«å†™æˆ¿é—´ï¼Œæˆ–è€…å¿«é€Ÿé€‰æˆ¿ã€‚',
                    })
                    return;
                }
                let room_data = await api.getRoom(room, mode);

                let msg = [`æˆ¿é—´å·${room}`, 'ğŸ‘¼ä»¥ä¸‹æ˜¯äººå‘˜ä¿¡æ¯:']

                room_data.players.forEach(x => {
                    msg.push(`${x.user} æ˜¯ ${getRoleEmoji(x.role)}  ${x.role}`)
                })

                Dialog.alert({
                    title: 'æŸ¥çœ‹ä¿¡æ¯',
                    message: msg.join('\n'),
                })


                //this.$data.godShow = true
            },
            async deleteRoom() {
                let room = this.$data.room
                Dialog.confirm({
                    title: 'ç¡®è®¤åˆ é™¤?',
                    message: `ä½ å°†ä¼šåˆ é™¤æˆ¿é—´å·ä¸º${room}çš„æˆ¿é—´...\nğŸ˜…ğŸ˜…ğŸ˜…çœŸçš„è¦åˆ å—...`
                }).then(() => {
                    api.delRoom(room)
                    Toast('åˆ é™¤æ“ä½œå®Œæˆ');
                    this.joined = false
                }).catch(() => {
                })
            },
            async showVote() {
                let room = this.$data.room
                if (!room || room === '') {
                    Dialog.alert({
                        title: 'æŠ•ç¥¨æ¨¡å¼å¤±è´¥',
                        message: 'è¯·å¡«å†™æˆ¿é—´ï¼Œæˆ–è€…å¿«é€Ÿé€‰æˆ¿ã€‚',
                    })
                    return;
                }
                let room_data = await api.getRoom(room, 'undercover');
                //è·å–å½“å‰æŠ•ç¥¨æ•°æ®
                let temp = []
                room_data.players.forEach(x => {
                    temp.push({
                        user: x.user,
                        role: (x.role == 'ç™½æ¿') ? 'ç™½æ¿' : x.role === room_data.undercover_data.undercover_word ? 'å§åº•' : 'å¹³æ°‘'
                    })
                })

                this.voteData = temp;
                this.voteShow = true;
            },
            votePlayer(user) {
                let u = this.voteData.find(x => x.user === user);
                if (u.role)
                    Dialog.alert({
                        message: user + 'çš„èº«ä»½...' + u.role
                    })
            }

        }
    });

    app.use(vant).mount('#app')
    app.use(vant.Button, vant.Overlay);
    app.use(vant.Field);
    app.use(vant.CellGroup);
    app.use(vant.Picker);
    app.use(vant.Tabbar, vant.TabbarItem);
    app.use(vant.Toast);
    app.use(Dialog);
</script>
</body>
</html>